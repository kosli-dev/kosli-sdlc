<blockquote class="book-hint info">
  Control ID: {{ .Page.Params.control_code }}
</blockquote>
<blockquote class="book-hint info">
  TLDR: {{ .Page.Params.tldr }}
</blockquote>
<blockquote class="book-hint info">
  Rationale: {{ .Page.Params.rationale }}
</blockquote>

{{/* Reverse-lookup: find which risks this control mitigates.
     Each risk page in /risk_register/ has a "mitigations" list in its
     front matter with url/name pairs pointing to control pages.
     We check each risk's mitigations to see if any url matches
     the current control page's permalink. */}}
{{ $currentURL := .Page.RelPermalink }}

{{/* Get all child pages of the risk_register section */}}
{{ $risks := (site.GetPage "/risk_register").Pages }}

{{/* Build a list of matching risks by scanning each risk's mitigations */}}
{{ $matched := slice }}
{{ range $risks }}
  {{/* Capture risk page title and URL before entering the inner range,
       because $ inside a shortcode's nested range refers to the shortcode
       context, not the current page in the outer range */}}
  {{ $riskTitle := .Title }}
  {{ $riskURL := .RelPermalink }}
  {{ range .Params.mitigations }}
    {{/* If this mitigation's url points to the current control page,
         add the risk to the matched list */}}
    {{ if eq .url $currentURL }}
      {{ $matched = $matched | append (dict "name" $riskTitle "url" $riskURL) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Only render the section if at least one risk references this control */}}
{{ if $matched }}
<h3>Mitigated Risks</h3>
<ul>
{{ range $matched }}
  <li><a href="{{ .url }}">{{ .name }}</a></li>
{{ end }}
</ul>
{{ end }}