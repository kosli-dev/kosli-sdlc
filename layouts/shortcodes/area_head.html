<blockquote class="book-hint info">
  Control ID: {{ .Page.Params.control_code }}
</blockquote>
<blockquote class="book-hint info">
  TLDR: {{ .Page.Params.tldr }}
</blockquote>
<blockquote class="book-hint info">
  Rationale: {{ .Page.Params.rationale }}
</blockquote>

{{/* Reverse-lookup: find which risks this control mitigates.
     Each risk page in /risks/ has a "mitigations" list in its
     front matter with url/name pairs pointing to control pages.
     We check each risk's mitigations to see if any url matches
     the current control page's permalink. */}}
{{ $currentURL := .Page.RelPermalink }}

{{/* Get all child pages of the risks section */}}
{{ $risks := (.Page.Site.GetPage "/risks").Pages }}

{{/* Build a list of matching risk pages by scanning each risk's mitigations */}}
{{ $matched := slice }}
{{ range $risks }}
  {{ $riskPage := . }}
  {{ range .Params.mitigations }}
    {{ if eq .url $currentURL }}
      {{ $matched = $matched | append $riskPage }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Only render the section if at least one risk references this control */}}
{{ if $matched }}
<h3>Mitigates Risk</h3>
<div class="card-row">
{{ range $index, $risk := $matched }}
  {{ partial "risk_card.html" (dict "page" $risk "index" $index) }}
{{ end }}
</div>
{{ end }}